<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ë¸”ë ˆìŠ¤ ë°ì´í„° í˜„í™© (ë“œë˜ê·¸ í¸ì§‘ ìµœì¢… ìˆ˜ì •)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* Base Styling */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a;
            color: #ddd;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            /* ì¤‘ìš”: ë“œë˜ê·¸ ì„ íƒ ì‹œ ë¸Œë¼ìš°ì € ê¸°ë³¸ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            user-select: none; 
        }

        .wrap {
            flex-grow: 1;
            padding: 20px 20px 20px 180px;
            position: relative;
            max-width: calc(100vw - 320px);
            overflow: auto;
        }
        
        /* Setting Panel Styling */
        .setting-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background-color: #2c2c2c;
            padding: 15px;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            z-index: 100;
            user-select: auto; /* íŒ¨ë„ ë‚´ë¶€ëŠ” ì„ íƒ ê°€ëŠ¥í•˜ê²Œ */
        }

        .setting-panel h3 {
            font-size: 1.1em;
            color: #ffdd66;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        
        .color-target-control label {
            margin-right: 15px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 5px 0;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #333;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border: 1px solid #555;
            cursor: pointer;
            border-radius: 3px;
            transition: transform 0.1s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #ffdd66;
        }

        .download-button {
            width: 100%;
            margin-top: 20px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .download-button:hover {
            background-color: #45a049;
        }

        /* Menu Styling */
        .top-sub-menu {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
        }

        .menu {
            margin-right: 20px;
            font-size: 0.9em;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .menu:hover {
            color: #fff;
        }

        .left-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 160px;
            height: 100vh;
            background-color: #222;
            padding: 20px 0;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.5);
        }

        .left-item {
            padding: 8px 15px;
            font-size: 0.9em;
            color: #bbb;
            cursor: pointer;
            transition: background-color 0.1s;
            border-left: 3px solid transparent;
        }

        .left-item.active, .left-item:hover {
            background-color: #333;
            border-left-color: #ffdd66;
            color: #fff;
        }

        /* Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            table-layout: fixed;
            user-select: auto; /* í…Œì´ë¸” ë‚´ë¶€ëŠ” í…ìŠ¤íŠ¸ í¸ì§‘ì„ ìœ„í•´ ì„ íƒ ê°€ëŠ¥ */
        }

        .data-table td {
            border: 1px solid #444;
            padding: 5px 8px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            line-height: 1;
            height: 15px;
            box-sizing: border-box;
            transition: background-color 0.1s, border-color 0.1s;
        }

        /* Row Group Styles */
        .top-notice-row td {
            background-color: #581616;
            color: #ffe6e6;
            font-weight: bold;
            text-align: left;
            padding: 8px 12px;
            height: 25px;
        }
        .top-notice-mark {
            color: #ffdd66;
            margin-right: 8px;
        }

        .top-data-header td, .bottom-data-header td {
            background-color: #444;
            color: #fff;
            font-weight: bold;
            height: 30px;
            min-width: 80px;
        }

        .middle-notice-row td {
            background-color: #3a3a3a;
            color: #ffb3b3;
            text-align: left;
            font-size: 0.9em;
            line-height: 1.4;
            height: 50px;
        }

        .bottom-data-row td {
            background-color: #333;
            color: #ddd;
        }
        
        /* Editable Content Styling */
        .data-table td[contenteditable="true"] {
            outline: none;
        }
        
        /* Selection Box (for drag visual) */
        #selectionBox {
            position: absolute;
            border: 2px dashed #FFD700;
            background-color: rgba(255, 215, 0, 0.2);
            pointer-events: none;
            z-index: 10;
            display: none;
        }

        /* Selected Cell Styling (Actual selection state) */
        .data-table td.selected {
            border: 2px solid #ffdd66 !important;
            box-shadow: inset 0 0 0 1px #ffdd66, 0 0 5px rgba(255, 221, 102, 0.5);
            position: relative;
            z-index: 5;
        }

        /* Resizer Styling (Placeholder) */
        .col-resizer { position: absolute; right: -4px; top: 0; width: 8px; height: 100%; cursor: col-resize; z-index: 20; }
        .row-resizer { position: absolute; bottom: -4px; right: 0; width: 100%; height: 8px; cursor: row-resize; z-index: 20; }
        .resizer-display { position: fixed; padding: 5px 10px; background: rgba(0, 0, 0, 0.8); color: #ffdd66; border-radius: 4px; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 101; font-size: 0.8em; white-space: nowrap; }
    </style>
</head>
<body>

<div class="setting-panel" id="settingPanel">
    
    <div style="color: #ffdd66; margin-top: 5px; margin-bottom: 10px; font-weight: bold;">
        â€» ì‚¬ìš©ë²•: í…Œì´ë¸” ì…€ì„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•œ í›„, ì•„ë˜ ì˜µì…˜ì„ í´ë¦­í•˜ë©´ ì ìš©ë©ë‹ˆë‹¤.
    </div>
    
    <div class="color-target-control">
        <label><input type="radio" name="colorTarget" value="text" checked> ê¸€ììƒ‰ ì ìš©</label>
        <label><input type="radio" name="colorTarget" value="background"> ë°°ê²½ìƒ‰ ì ìš©</label>
    </div>
    
    <div class="color-control">
        <h3>ğŸ¨ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì„ íƒ (40ìƒ‰)</h3>
        <div class="color-palette">
            </div>
    </div>
    
    <div style="margin-top: 10px; padding-top: 15px; border-top: 1px solid #444;">
        <label for="fontSizeInput">ê¸€ê¼´ í¬ê¸° (px): </label>
        <input type="number" id="fontSizeInput" min="8" max="48" value="14" style="width: 60px; margin-left: 5px; padding: 5px; color: black; border-radius: 3px; border: none;">
        <button id="applyFontSizeBtn" style="margin-left: 5px; padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer; transition: background 0.2s;">ì ìš©</button>
    </div>
    
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
        <h3>ğŸ“ ê·¸ë£¹ë³„ í–‰ ë†’ì´ (px)</h3>
        
        <div style="margin-bottom: 10px;">
            <label for="topRowHeightInput" style="display: block; margin-bottom: 5px;">ìƒë‹¨ ë°ì´í„° í–‰ ë†’ì´:</label>
            <input type="number" id="topRowHeightInput" min="10" max="100" value="15" style="width: 60px; padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyTopRowHeightBtn" class="height-apply-btn" data-target="top-data" style="margin-left: 5px; padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer;">ì ìš©</button>
        </div>

        <div style="margin-bottom: 10px;">
            <label for="middleNoticeRowHeightInput" style="display: block; margin-bottom: 5px;">ì¤‘ë‹¨ ê³µì§€/ì œëª© í–‰ ë†’ì´:</label>
            <input type="number" id="middleNoticeRowHeightInput" min="20" max="200" value="30" style="width: 60px; padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyMiddleNoticeRowHeightBtn" class="height-apply-btn" data-target="middle-notice" style="margin-left: 5px; padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer;">ì ìš©</button>
        </div>

        <div>
            <label for="bottomRowHeightInput" style="display: block; margin-bottom: 5px;">í•˜ë‹¨ ë°ì´í„° í–‰ ë†’ì´:</label>
            <input type="number" id="bottomRowHeightInput" min="10" max="100" value="15" style="width: 60px; padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyBottomRowHeightBtn" class="height-apply-btn" data-target="bottom-data" style="margin-left: 5px; padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer;">ì ìš©</button>
        </div>
    </div>
    <button class="download-button" id="downloadBtn">
        ğŸ–¼ï¸ í…Œì´ë¸” ì˜ì—­ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (PNG)
    </button>
</div>

<div class="wrap">
    <div id="selectionBox"></div>

    <div class="top-sub-menu">
        <div class="menu">ë¸”ë ˆìŠ¤ ì „êµ­ í”„ë ˆìŠ¤í‹°ì§€ ì„œë¹„ìŠ¤</div>
        <div class="menu">VIP íšŒì› ì „ìš© í†µí•© ë§¤ë‹ˆì§€ë¨¼íŠ¸</div>
        <div class="menu">ë…¸ë¸”ë ˆìŠ¤ íšŒì› ì „ìš©ë£¸</div>
    </div>
    
    <div class="left-menu">
        <div class="left-item active">ë©”ì¸ í™”ë©´</div>
        <div class="left-item">[ë§¤ì¹­/ê³ ê° ìƒíƒœ]</div>
        <div class="left-item">ì£¼ë¬¸ ìƒíƒœ</div>
        <div class="left-item">ì¸ì¦ ìƒíƒœ</div>
        <div class="left-item">[ìƒë‹´/ë¬¸ì˜]</div>
        <div class="left-item">ì§ë¬´ ë¬¸ì˜</div>
        <div class="left-item">ì „êµ­ ë§Œë‚¨</div>
        <div class="left-item">[ê´€ë¦¬/ë°ì´í„°]</div>
        <div class="left-item">ì‹¤ì‹œê°„ ë°ì´í„°</div>
        <div class="left-item">ì‹¤ì‹œê°„ ì˜¤ë¥˜</div>
        <div class="left-item">ë°ì´í„° ë¶„ì„</div>
        <div class="left-item">í¬ì¸íŠ¸ ì¡°íšŒ</div>
        <div class="left-item">ìœ í¥ ê´€ë¦¬</div>
        <div class="left-item">íšŒì› ê´€ë¦¬</div>
        <div class="left-item">íšŒì› ìŠ¹ì¸</div>
        <div class="left-item">íšŒì› íƒˆí‡´</div>
        <div class="left-item">ë‹´ë‹¹ ì‹¤ì¥</div>
    </div>

    <table class="data-table" id="capture-area">
        <tbody>
            <tr class="top-notice-row">
                <td colspan="5" contenteditable="true"> 
                    <span class="top-notice-mark">DAMAGE!</span> ì£¼ì˜ì‚¬í•­ 4ë‹¨ê³„ì—ì„œ ì¼ì¹˜ íŒŒíŠ¸ë„ˆì‹­ìœ¼ë¡œ í†µí•©ëœ ìœ í˜•ë§Œì„ ì„ íƒí•˜ì—¬ ê³µìœ  ì„ë¬´ë¥¼ ì™„ë£Œí•˜ë©° í•¨ê»˜ í• ë•Œì˜ ê¸ˆì¼ ê²°ì œ ê¸ˆì•¡ í›„ ê³µë™ ì´ìµì„ ë§ˆê°í•´ì•¼ í•©ë‹ˆë‹¤!
                </td>
            </tr>
            
            <tr class="top-data-header">
                <td contenteditable="true">íšŒì›ID</td>
                <td contenteditable="true">ì£¼ë¬¸ìƒíƒœ</td>
                <td contenteditable="true">ì¸ì¦ìƒíƒœ</td> 
                <td contenteditable="true">í™œì„±í™” ì½”ë“œ</td> 
                <td contenteditable="true">ìŠ¹ì¸ëœ ì•”í˜¸ ì½”ë“œ</td> 
            </tr>
            
            <tr class="top-data-row">
                <td contenteditable="true">jkgov1203</td>
                <td contenteditable="true">ë°œì†¡ ì™„ë£Œ</td>
                <td contenteditable="true">ìŠ¹ì¸ ì™„ë£Œ</td>
                <td contenteditable="true">NSACT2032897</td>
                <td contenteditable="true">NBS001001001</td> 
            </tr>
            <tr class="top-data-row">
                <td contenteditable="true">sxcv4752</td>
                <td contenteditable="true">ê²€ìˆ˜ ëŒ€ê¸°</td>
                <td contenteditable="true">ë¯¸ìŠ¹ì¸</td>
                <td contenteditable="true">NSACT2032898</td>
                <td contenteditable="true">NBS001001002</td> 
            </tr>
            <tr class="top-data-row">
                <td contenteditable="true">qwerty24689</td>
                <td contenteditable="true">ì§„í–‰ ì¤‘</td>
                <td contenteditable="true">ìŠ¹ì¸ ì™„ë£Œ</td>
                <td contenteditable="true">NSACT2032899</td>
                <td contenteditable="true">NBS001001003</td> 
            </tr>
            <tr class="top-data-row">
                <td contenteditable="true">xsgf1575</td>
                <td contenteditable="true">ë°œì†¡ ì˜¤ë¥˜</td>
                <td contenteditable="true">ë¹„í™œì„±í™”</td>
                <td contenteditable="true">NSACT2032891</td>
                <td contenteditable="true">NBS001001004</td> 
            </tr>
            
            <tr class="middle-notice-row">
                <td colspan="5" contenteditable="true"> 
                    1. ìœ„ ê³µë™êµ¬ë§¤ íšŒì›ë“¤ì´ í´ë¦¬ì–´ ë°ì´í„°ë¥¼ ì§€ì‹œì— ë”°ë¼ ì§„í–‰í•˜ì§€ ëª»í•˜ì—¬ ì‹¤íŒ¨ë¡œ ì¸í•´ íšŒì›ê°€ì… ë° ê³„ì • ë¹„í™œì„±í™”ë˜ì–´ ì¶œê¸ˆë¶ˆê°€ <br>
                    2. ìƒí˜¸í˜‘ë ¥ì˜ ë°œì „ëª©ì ì„ ì‹¤ì²œí•˜ê¸° ìœ„í•´ ê³µì‹ì ìœ¼ë¡œ 1~2íšŒ ì—°ì† í´ë¦¬ì–´ìˆ˜ì •ì„ íŠ¹ë³„íˆ ìŠ¹ì¸í•˜ì˜€ìœ¼ë©°, ìˆ˜ì •ì£¼ë¬¸ì€ ë§Œì¥ì¼ì¹˜ë¡œ í•©ì˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.<br>
                    3. ìˆ˜ì •ì£¼ë¬¸ì€ ê³„ì¢Œì™€ ê³„ì¢Œ ì´ìƒ ë°ì´í„° ë³µêµ¬ í›„ ì¶œê¸ˆ ì½”ë“œë¥¼ ë§¤ë‹ˆì € ê°±ì‹ ì„ ì™„ë£Œí•´ì•¼ ì¶œê¸ˆê°€ëŠ¥í•˜ë©° ë°ì´í„° ì™„ë£Œ ì´ì „ì—ëŠ” í˜„ê¸ˆ ì¶œê¸ˆì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤<br>
                    4.ì •ì‚°ì‹œìŠ¤í…œì—ì„œ ìŠ¹ì¸í•  ìˆ˜ ì—†ì–´ ì¶œê¸ˆí• ìˆ˜ ì—†ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„° ì™„ë£Œ ì´ì „ì—ëŠ” í˜„ê¸ˆ ì¶œê¸ˆì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                    (ì˜ˆ: ë¶€í™œ í¬ê¸°í•œ ê³„ì •ì˜ ê²½ìš° í¬ì¸íŠ¸ì¶œê¸ˆ ë¶ˆê°€)
                </td>
            </tr>

            <tr class="bottom-data-header">
                <td class="w-20" contenteditable="true">ì£¼ë¬¸ìœ í˜•</td>
                <td class="w-20" contenteditable="true">ì£¼ë¬¸ìƒì„¸</td>
                <td contenteditable="true">íˆ¬ìê¸ˆì•¡ (ì›)</td>
                <td contenteditable="true">ì›ê¸ˆ+ìˆ˜ìµê¸ˆì•¡</td>
                <td contenteditable="true">ë³´ì¥ë¹„ìœ¨</td>
            </tr>

            <tr class="bottom-data-row">
                <td contenteditable="true">A</td>
                <td contenteditable="true">[2ì¢…íƒ1]</td>
                <td contenteditable="true" style="color: #FF0000;">1,500,000</td>
                <td contenteditable="true">1,650,000</td>
                <td contenteditable="true" style="color: #FF0000;">0%</td>
            </tr>
            <tr class="bottom-data-row">
                <td contenteditable="true">B</td>
                <td contenteditable="true">[2ì¢…íƒ1]</td>
                <td contenteditable="true">2,500,000</td>
                <td contenteditable="true">2,750,000</td>
                <td contenteditable="true">100%</td>
            </tr>
            <tr class="bottom-data-row">
                <td contenteditable="true">C</td>
                <td contenteditable="true">[2ì¢…íƒ1]</td>
                <td contenteditable="true">0</td>
                <td contenteditable="true">0</td>
                <td contenteditable="true" style="color: #FF0000;">0%</td>
            </tr>
            <tr class="bottom-data-row">
                <td contenteditable="true">D</td>
                <td contenteditable="true">[2ì¢…íƒ1]</td>
                <td contenteditable="true">0</td>
                <td contenteditable="true">0</td>
                <td contenteditable="true" style="color: #FF0000;">0%</td>
            </tr>

        </tbody>
    </table>
</div>

<div class="resizer-display" id="resizerDisplay"></div>

<script type="module">
// Firebase Imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Global Variables and Firebase Setup ---
const TABLE_DOC_ID = 'main_table_state';
// IMPORTANT: Ensure __firebase_config and __app_id are defined in the parent environment/html
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUserId = null;
let isAuthReady = false;
let hasLoadedState = false; 

// Color Palette (40 colors)
const COLOR_PALETTE = [
    '#FFFFFF', '#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF', '#FF00FF',
    '#FFA500', '#800080', '#008000', '#808000', '#000080', '#800000', '#C0C0C0', '#808080',
    '#FF4500', '#ADFF2F', '#1E90FF', '#FFD700', '#20B2AA', '#E9967A', '#9400D3', '#FF69B4',
    '#A0522D', '#D2B48C', '#87CEEB', '#F08080', '#4682B4', '#DA70D6', '#B0C4DE', '#F4A460',
    '#5F9EA0', '#DDA0DD', '#7FFF00', '#6495ED', '#DC143C', '#FF8C00', '#9ACD32', '#40E0D0'
];

// Element References
const table = document.querySelector('.data-table');
const colorPaletteContainer = document.querySelector('.color-palette');
const applyFontSizeBtn = document.getElementById('applyFontSizeBtn');
const fontSizeInput = document.getElementById('fontSizeInput');
const downloadButton = document.getElementById('downloadBtn');
const selectionBox = document.getElementById('selectionBox');

// --- Drag Selection Variables ---
let isDragging = false;
let startCell = null;
let endCell = null;
let isResizing = false;

// --- 1. Firebase Authentication & Data Path Setup ---

const getTableDocRef = (userId) => {
    return doc(db, 'artifacts', appId, 'users', userId, 'table_data', TABLE_DOC_ID);
};

const initAuthAndListeners = async () => {
    try {
        if (typeof __initial_auth_token !== 'undefined') {
            await signInWithCustomToken(auth, __initial_auth_token);
        }
    } catch (error) {
        console.error("Custom token sign-in failed, attempting anonymous sign-in.", error);
    }
    
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
        } else {
            try {
                await signInAnonymously(auth);
                currentUserId = auth.currentUser.uid;
            } catch (error) {
                console.error("Anonymous sign-in failed.", error);
                return;
            }
        }
        
        // ì¸ì¦ì´ ì™„ë£Œë˜ë©´ ë°ì´í„° ë¡œë“œë§Œ ìˆ˜í–‰ (ë¦¬ìŠ¤ë„ˆëŠ” ì´ë¯¸ ë“±ë¡ë¨)
        if (currentUserId && !hasLoadedState) {
            isAuthReady = true;
            loadTableState(currentUserId);
            hasLoadedState = true;
            console.log("Auth ready, state loading initiated.");
        }
    });
};

initAuthAndListeners();

// --- 2. State Management (Save/Load) ---

let initialLoadDone = false;

const saveTableState = async (userId) => {
    if (!userId || !isAuthReady) {
        console.warn("Cannot save state: Auth not ready.");
        return;
    }

    const cellStates = {};
    const rowHeights = {};
    
    // 1. Save Cell Contents and Styles
    const rows = table.querySelectorAll('tr');
    rows.forEach((row, rIndex) => {
        row.querySelectorAll('td').forEach((cell, cIndex) => {
            const cellId = `r${rIndex}c${cIndex}`;
            cellStates[cellId] = {
                text: cell.innerHTML,
                color: cell.style.color || '',
                bg: cell.style.backgroundColor || '',
                fontSize: cell.style.fontSize || '',
            };
        });
    });

    // 2. Save Row Group Heights
    document.querySelectorAll('.height-apply-btn').forEach(button => {
        const target = button.dataset.target;
        let inputId = `${target.replace('-data', 'RowHeightInput')}`;
        if (target === 'middle-notice') inputId = 'middleNoticeRowHeightInput';
        const input = document.getElementById(inputId);
        if (input) rowHeights[target] = input.value;
    });

    const tableState = {
        cells: cellStates,
        rowHeights: rowHeights,
        timestamp: new Date()
    };
    
    try {
        await setDoc(getTableDocRef(userId), tableState, { merge: true });
        console.log("Table state saved successfully.");
    } catch (e) {
        console.error("Error saving table state: ", e);
    }
};

const loadTableState = (userId) => {
    if (!userId) return;
    const docRef = getTableDocRef(userId);

    onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            applyLoadedState(data);
        } else if (!initialLoadDone) {
            saveTableState(userId);
        }
        initialLoadDone = true;
    }, (error) => console.error("Error listening to state changes:", error));
};

const applyLoadedState = (data) => {
    if (data.cells) {
        const rows = table.querySelectorAll('tr');
        rows.forEach((row, rIndex) => {
            row.querySelectorAll('td').forEach((cell, cIndex) => {
                const cellId = `r${rIndex}c${cIndex}`;
                const state = data.cells[cellId];
                if (state) {
                    if (cell.innerHTML !== state.text) cell.innerHTML = state.text;
                    cell.style.color = state.color || '';
                    cell.style.backgroundColor = state.bg || '';
                    cell.style.fontSize = state.fontSize || '';
                }
            });
        });
    }

    if (data.rowHeights) {
        for (const [key, value] of Object.entries(data.rowHeights)) {
            let inputId = `${key.replace('-data', 'RowHeightInput')}`;
            if (key === 'middle-notice') inputId = 'middleNoticeRowHeightInput';
            const input = document.getElementById(inputId);
            if (input) input.value = value;
            applyRowHeight(key, value);
        }
    }
    clearSelection();
};

// --- 3. Cell Interaction Logic (Drag Selection) ---

// ë“œë˜ê·¸ ì‹œì‘ ë¡œì§ ê°œì„ : í…ìŠ¤íŠ¸ í¸ì§‘ê³¼ ë“œë˜ê·¸ ì„ íƒ ì¶©ëŒ ë°©ì§€
const handleDragStart = (e) => {
    if (e.target.closest('.col-resizer') || e.target.closest('.row-resizer') || isResizing || e.target.closest('.setting-panel')) {
        return;
    }
    
    const cell = e.target.closest('td');
    if (!cell) return;

    // í¸ì§‘ ê°€ëŠ¥í•œ ì…€ í´ë¦­ ì‹œ: Ctrl/Meta í‚¤ê°€ ì—†ìœ¼ë©´ ì¼ë‹¨ í…ìŠ¤íŠ¸ í¸ì§‘ìœ¼ë¡œ ê°„ì£¼
    if (cell.isContentEditable && !e.ctrlKey && !e.metaKey) {
         startCell = cell;
         // ë§ˆìš°ìŠ¤ê°€ ì›€ì§ì´ë©´ ë“œë˜ê·¸ë¡œ ì „í™˜í•˜ê¸° ìœ„í•´ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
         document.addEventListener('mousemove', handleDraggingCheck);
         document.addEventListener('mouseup', handleDragEndCleanup);
         return;
    }

    // Ctrl í‚¤ë¥¼ ëˆŒë €ê±°ë‚˜ í¸ì§‘ ë¶ˆê°€ëŠ¥í•œ ì˜ì—­ í´ë¦­ ì‹œ ì¦‰ì‹œ ë“œë˜ê·¸ ì‹œì‘
    e.preventDefault();
    startDragSelection(cell, e.shiftKey);
};

// ë§ˆìš°ìŠ¤ ì›€ì§ì„ ê°ì§€í•˜ì—¬ ë“œë˜ê·¸ ì‹œì‘ ì—¬ë¶€ ê²°ì •
const handleDraggingCheck = (e) => {
    isDragging = true; // ì›€ì§ì˜€ìœ¼ë¯€ë¡œ ë“œë˜ê·¸ë¡œ ê°„ì£¼
    document.removeEventListener('mousemove', handleDraggingCheck);
    document.removeEventListener('mouseup', handleDragEndCleanup);
    
    window.getSelection()?.removeAllRanges(); // ê¸°ì¡´ í…ìŠ¤íŠ¸ ì„ íƒ í•´ì œ
    
    startDragSelection(startCell, false); // ë“œë˜ê·¸ ì„ íƒ ì‹œì‘
    handleDragging(e); // ì²« ì›€ì§ì„ ì²˜ë¦¬
};

// í´ë¦­ë§Œ í•˜ê³  ëë‚¬ì„ ë•Œ ì •ë¦¬
const handleDragEndCleanup = () => {
     document.removeEventListener('mousemove', handleDraggingCheck);
     document.removeEventListener('mouseup', handleDragEndCleanup);
     startCell = null;
}

const startDragSelection = (cell, isShiftPressed) => {
    isDragging = true;
    startCell = cell;

    if (!isShiftPressed) {
        clearSelection();
    }
    
    startCell.classList.add('selected');
    selectionBox.style.display = 'block';
    updateSelectionBoxVisual(startCell, startCell);

    document.addEventListener('mousemove', handleDragging);
    document.addEventListener('mouseup', handleDragEnd);
}

const handleDragging = (e) => {
    if (!isDragging) return;
    e.preventDefault(); 

    const cellUnderMouse = e.target.closest('td');
    if (cellUnderMouse && table.contains(cellUnderMouse)) {
        endCell = cellUnderMouse;
        selectCellsInDragArea(startCell, endCell);
        updateSelectionBoxVisual(startCell, endCell);
    }
};

const handleDragEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    startCell = null;
    endCell = null;
    selectionBox.style.display = 'none';
    document.removeEventListener('mousemove', handleDragging);
    document.removeEventListener('mouseup', handleDragEnd);
};

const clearSelection = () => {
     document.querySelectorAll('.data-table td.selected').forEach(cell => cell.classList.remove('selected'));
}

const selectCellsInDragArea = (startCell, endCell) => {
    if (!startCell || !endCell) return;

    const allRows = Array.from(table.querySelectorAll('tr'));
    
    const getCellIndices = (cell) => {
        const row = cell.parentElement;
        const rowIndex = allRows.indexOf(row);
        const cellRect = cell.getBoundingClientRect();
        return { rowIndex, cellRect };
    };

    const start = getCellIndices(startCell);
    const end = getCellIndices(endCell);

    if (start.rowIndex === -1 || end.rowIndex === -1) return;

    const top = Math.min(start.cellRect.top, end.cellRect.top);
    const bottom = Math.max(start.cellRect.bottom, end.cellRect.bottom);
    const left = Math.min(start.cellRect.left, end.cellRect.left);
    const right = Math.max(start.cellRect.right, end.cellRect.right);

    clearSelection();

    table.querySelectorAll('td').forEach(cell => {
        const cellRect = cell.getBoundingClientRect();
        if (cellRect.top < bottom && cellRect.bottom > top &&
            cellRect.left < right && cellRect.right > left) {
            cell.classList.add('selected');
        }
    });
};

const updateSelectionBoxVisual = (cell1, cell2) => {
    if (!selectionBox || !cell1 || !cell2) return;
    const rect1 = cell1.getBoundingClientRect();
    const rect2 = cell2.getBoundingClientRect();

    const left = Math.min(rect1.left, rect2.left);
    const top = Math.min(rect1.top, rect2.top);
    const right = Math.max(rect1.right, rect2.right);
    const bottom = Math.max(rect1.bottom, rect2.bottom);
    
    const wrapRect = document.querySelector('.wrap').getBoundingClientRect();
    const wrapEl = document.querySelector('.wrap');

    selectionBox.style.left = (left - wrapRect.left + wrapEl.scrollLeft) + 'px';
    selectionBox.style.top = (top - wrapRect.top + wrapEl.scrollTop) + 'px';
    selectionBox.style.width = (right - left) + 'px';
    selectionBox.style.height = (bottom - top) + 'px';
};


// --- 4. Control Panel & Event Listeners (Executed Immediately) ---

// [ìˆ˜ì •ë¨] ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì¦‰ì‹œ ìƒì„±
COLOR_PALETTE.forEach(color => {
    const swatch = document.createElement('div');
    swatch.className = 'color-swatch';
    swatch.style.backgroundColor = color;
    swatch.dataset.color = color;
    colorPaletteContainer.appendChild(swatch);
});

// [ìˆ˜ì •ë¨] í…Œì´ë¸” ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì¦‰ì‹œ ì—°ê²°
table.addEventListener('mousedown', handleDragStart);

// ìŠ¤íƒ€ì¼ ì ìš© í•¨ìˆ˜
const applyStyleToSelectedCells = (styleProp, value) => {
    const selectedCells = document.querySelectorAll('.data-table td.selected');
    
    if (selectedCells.length === 0) {
        alert("ìŠ¤íƒ€ì¼ì„ ì ìš©í•  ì…€ì„ ë¨¼ì € ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    selectedCells.forEach(cell => {
        cell.style[styleProp] = value;
    });

    if (currentUserId && isAuthReady) {
         saveTableState(currentUserId);
    }
};

// [ìˆ˜ì •ë¨] ì»¨íŠ¸ë¡¤ íŒ¨ë„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¦‰ì‹œ ì—°ê²°
// 1. ìƒ‰ìƒ í´ë¦­ ì´ë²¤íŠ¸
colorPaletteContainer.addEventListener('click', (e) => {
    const swatch = e.target.closest('.color-swatch');
    if (!swatch) return;
    const color = swatch.dataset.color;
    const target = document.querySelector('input[name="colorTarget"]:checked').value;
    
    if (target === 'text') {
        applyStyleToSelectedCells('color', color);
    } else {
        applyStyleToSelectedCells('backgroundColor', color);
    }
});

// 2. ê¸€ê¼´ í¬ê¸° ì ìš© ì´ë²¤íŠ¸
applyFontSizeBtn.addEventListener('click', () => {
    const size = parseInt(fontSizeInput.value, 10);
    if (size && size >= 8 && size <= 48) {
        applyStyleToSelectedCells('fontSize', `${size}px`);
    } else {
        alert("ê¸€ê¼´ í¬ê¸°ëŠ” 8px ~ 48px ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    }
});

// 3. í–‰ ë†’ì´ ì ìš© ì´ë²¤íŠ¸
document.querySelectorAll('.height-apply-btn').forEach(button => {
    button.addEventListener('click', (e) => {
        const target = e.currentTarget.dataset.target;
        let inputId = `${target.replace('-data', 'RowHeightInput')}`;
        if (target === 'middle-notice') inputId = 'middleNoticeRowHeightInput';
        const input = document.getElementById(inputId);
        if (!input) return;
        
        const height = parseInt(input.value, 10);
        if (height > 0) {
            applyRowHeight(target, height);
            if (currentUserId && isAuthReady) saveTableState(currentUserId);
        }
    });
});

// 4. ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì´ë²¤íŠ¸
downloadButton.addEventListener('click', () => {
    clearSelection();
    selectionBox.style.display = 'none';
    
    const element = document.getElementById('capture-area');
    html2canvas(element, { scale: 2, backgroundColor: '#1a1a1a' }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'ë…¸ë¸”ë ˆìŠ¤_ë°ì´í„°_í˜„í™©.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
});


// Helper for applying row heights
const applyRowHeight = (targetClassPrefix, height) => {
    let selector = '';
    if (targetClassPrefix === 'top-data') selector = '.top-data-header, .top-data-row';
    else if (targetClassPrefix === 'middle-notice') selector = '.middle-notice-row';
    else if (targetClassPrefix === 'bottom-data') selector = '.bottom-data-header, .bottom-data-row';
    else return;

    const rows = table.querySelectorAll(selector);
    rows.forEach(row => {
        row.querySelectorAll('td').forEach(cell => {
            cell.style.height = `${height}px`;
            cell.style.paddingTop = '0px';
            cell.style.paddingBottom = '0px';
            cell.style.lineHeight = '1';
        });
        row.style.height = `${height}px`;
    });
};

// í…ìŠ¤íŠ¸ í¸ì§‘ ì—”í„°í‚¤ ì²˜ë¦¬
table.addEventListener('keydown', (e) => {
    if (e.target.isContentEditable && e.key === 'Enter') {
        e.preventDefault();
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        const br = document.createElement('br');
        range.deleteContents();
        range.insertNode(br);
        range.setStartAfter(br);
        range.setEndAfter(br);
        selection.removeAllRanges();
        selection.addRange(range);
    }
});

// í¸ì§‘ ì¢…ë£Œ ì‹œ ìë™ ì €ì¥
table.addEventListener('blur', (e) => {
    if (e.target.isContentEditable && currentUserId && isAuthReady) {
        saveTableState(currentUserId);
    }
}, true);

</script>
</body>
</html>
