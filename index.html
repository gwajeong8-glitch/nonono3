<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ë¸”ë ˆìŠ¤ ë°ì´í„° í˜„í™© (ìµœì¢… í†µí•©ë³¸)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* ---------------------------------- */
        /* 1. Base Styling           */
        /* ---------------------------------- */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a; /* ë‹¤í¬ ëª¨ë“œ ë°°ê²½ */
            color: #ddd;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            user-select: none; /* ë“œë˜ê·¸ ì„ íƒ ì‹œ ë¸Œë¼ìš°ì € ê¸°ë³¸ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        .wrap {
            flex-grow: 1;
            /* ì™¼ìª½ ë©”ë‰´(180px)ì™€ ì˜¤ë¥¸ìª½ íŒ¨ë„(300px)ì„ ìœ„í•œ ì—¬ë°± */
            padding: 20px 20px 20px 200px; 
            position: relative;
            max-width: calc(100vw - 320px);
            overflow: auto;
        }

        /* ---------------------------------- */
        /* 2. Menu & Logo Styling    */
        /* ---------------------------------- */
        
        /* New: ë¡œê³  ìŠ¤íƒ€ì¼ (ì˜¤ë¥¸ìª½ ìƒë‹¨) */
        .header-logo {
            position: absolute;
            top: 10px;      /* ìƒë‹¨ ì—¬ë°± */
            right: 10px;    /* ìš°ì¸¡ ì—¬ë°± */
            width: 120px;   /* ë¡œê³  í¬ê¸° */
            height: auto;
            z-index: 10;    /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
            filter: drop-shadow(0 0 5px rgba(255, 221, 102, 0.4)); /* ë¹› íš¨ê³¼ */
        }
        
        /* Left menu */
        .left-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 180px;
            height: 100vh;
            background-color: #222;
            padding: 20px 0;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.5);
            z-index: 99;
            overflow-y: auto;
        }

        .left-item {
            padding: 10px 16px;
            font-size: 0.95em;
            color: #bbb;
            cursor: pointer;
            transition: background-color 0.12s, color 0.12s;
            border-left: 6px solid transparent;
            margin-bottom: 4px;
            border-radius: 0 6px 6px 0;
        }

        .left-item:hover {
            background: rgba(255,221,102,0.03);
            color: #fff;
        }

        .left-item.active {
            background: linear-gradient(90deg, rgba(255,221,102,0.06), rgba(255,221,102,0.02));
            border-left-color: #ffdd66;
            color: #fff;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        /* Top Sub Menu */
        .top-sub-menu {
            display: flex;
            margin-bottom: 12px;
            border-bottom: 2px solid #555;
            padding-bottom: 8px;
        }

        .menu {
            margin-right: 20px;
            font-size: 0.9em;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .menu:hover {
            color: #fff;
        }
        .menu.active { 
            color: #fff; 
            font-weight: 600; 
            border-bottom: 2px solid #ffdd66; 
            padding-bottom: 6px;
        }

        /* menu indicator */
        .menu-indicator {
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(255,221,102,0.06);
            color: #ffdd66;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        /* ---------------------------------- */
        /* 3. Table Styling          */
        /* ---------------------------------- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            table-layout: fixed;
            user-select: auto; /* í…Œì´ë¸” ë‚´ë¶€ëŠ” í…ìŠ¤íŠ¸ í¸ì§‘ì„ ìœ„í•´ ì„ íƒ ê°€ëŠ¥ */
        }

        .data-table td {
            border: 1px solid #444;
            padding: 5px 8px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            height: 25px; /* ì´ˆê¸° ë†’ì´ ì„¤ì •, JSë¡œ ë™ì  ë³€ê²½ */
            box-sizing: border-box;
            transition: background-color 0.1s, border-color 0.1s;
        }
        
        /* Row Group Styles */
        .top-notice-row td {
            background-color: #581616;
            color: #ffe6e6;
            font-weight: bold;
            text-align: left;
            padding: 8px 12px;
            height: 25px;
        }
        .top-notice-mark {
            color: #ffdd66;
            margin-right: 8px;
        }

        .top-data-header td, .bottom-data-header td {
            background-color: #444;
            color: #fff;
            font-weight: bold;
            height: 30px;
            min-width: 80px;
        }

        .middle-notice-row td {
            background-color: #3a3a3a;
            color: #ffb3b3;
            text-align: left;
            font-size: 0.9em;
            line-height: 1.4;
            height: 50px;
        }

        .bottom-data-row td {
            background-color: #333;
            color: #ddd;
        }

        /* Editable Content Styling */
        .data-table td[contenteditable="true"] {
            outline: none;
        }
        .data-table td[contenteditable="false"] {
            cursor: not-allowed;
        }
        
        /* Selection Styles */
        #selectionBox {
            position: absolute;
            border: 2px dashed #FFD700;
            background-color: rgba(255, 215, 0, 0.2);
            pointer-events: none;
            z-index: 10;
            display: none;
        }

        .data-table td.selected {
            border: 2px solid #ffdd66 !important;
            box-shadow: inset 0 0 0 1px #ffdd66, 0 0 5px rgba(255, 221, 102, 0.5);
            position: relative;
            z-index: 5;
        }

        /* Resizer Styles */
        .col-resizer { 
            position: absolute; right: -4px; top: 0; width: 8px; height: 100%; 
            cursor: col-resize; z-index: 20;
        }
        .row-resizer { 
            position: absolute; bottom: -4px; right: 0; width: 100%; height: 8px;
            cursor: row-resize; z-index: 20; 
        }
        .resizer-display { 
            position: fixed; padding: 5px 10px; background: rgba(0, 0, 0, 0.8); 
            color: #ffdd66; border-radius: 4px; pointer-events: none; 
            opacity: 0; transition: opacity 0.2s; z-index: 101; font-size: 0.8em;
            white-space: nowrap; 
        }

        /* ---------------------------------- */
        /* 4. Setting Panel          */
        /* ---------------------------------- */
        .setting-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background-color: #2c2c2c;
            padding: 15px;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            z-index: 100;
            user-select: auto;
        }

        .setting-panel h3 {
            font-size: 1.1em;
            color: #ffdd66;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 5px 0;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #333;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border: 1px solid #555;
            cursor: pointer;
            border-radius: 3px;
            transition: transform 0.1s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #ffdd66;
        }

        .small-btn { 
            padding:6px 8px; background:#444; color:#fff; border-radius:4px; border:none; 
            cursor:pointer; font-size: 0.9em; flex-grow: 1; text-align: center;
        }
        .small-btn:hover{background:#555}
        .small-btn:disabled{background:#222; cursor:not-allowed; color:#888;}
        .small-btn#autoSaveToggleBtn.active { background-color: #007bff; }
        .small-btn#toggleAdminBtn.active { background-color: #f00; }

        .download-button {
            width: 100%;
            margin-top: 20px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .download-button:hover { background-color: #45a049; }

        /* small responsive fix */
        @media (max-width: 900px) {
            .wrap { padding-left: 20px; }
            .left-menu { display: none; }
        }
    </style>
</head>
<body>

<div class="setting-panel" id="settingPanel">
    <div style="color: #ffdd66; margin-top: 5px; margin-bottom: 10px; font-weight: bold;">
        â€» ì‚¬ìš©ë²•: í…Œì´ë¸” ì…€ì„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•œ í›„, ì•„ë˜ ì˜µì…˜ì„ í´ë¦­í•˜ë©´ ì ìš©ë©ë‹ˆë‹¤.
    </div>

    <div class="color-target-control">
        <label><input type="radio" name="colorTarget" value="text" checked> ê¸€ììƒ‰ ì ìš©</label>
        <label><input type="radio" name="colorTarget" value="background"> ë°°ê²½ìƒ‰ ì ìš©</label>
    </div>

    <div class="color-control">
        <h3>ğŸ¨ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì„ íƒ (40ìƒ‰)</h3>
        <div class="color-palette" id="colorPaletteContainer"></div>
    </div>

    <div style="margin-top: 10px; padding-top: 15px; border-top: 1px solid #444;">
        <label for="fontSizeInput">ê¸€ê¼´ í¬ê¸° (px): </label>
        <input 
        type="number" id="fontSizeInput" min="8" max="48" value="14" style="width: 60px; margin-left: 5px; padding: 5px; color: black; border-radius: 3px; border: none;">
        <button id="applyFontSizeBtn" style="margin-left: 5px; padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer; transition: background 0.2s;">ì ìš©</button>
    </div>

    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
        <h3>ğŸ“ ê·¸ë£¹ë³„ í–‰ ë†’ì´ (px)</h3>
        
        <div style="margin-bottom: 10px;">
        <label for="topRowHeightInput" style="display: block; margin-bottom: 5px;">ìƒë‹¨ ë°ì´í„° í–‰ ë†’ì´:</label>
            <input type="number" id="topRowHeightInput" min="10" max="200" value="25" style="width: 60px;
        padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyTopRowHeightBtn" class="height-apply-btn" data-target="top-data" style="margin-left: 5px;
        padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px;
        cursor: pointer;">ì ìš©</button>
        </div>

        <div style="margin-bottom: 10px;">
            <label for="middleNoticeRowHeightInput" style="display: block;
        margin-bottom: 5px;">ì¤‘ë‹¨ ê³µì§€/ì œëª© í–‰ ë†’ì´:</label>
            <input type="number" id="middleNoticeRowHeightInput" min="20" max="300" value="50" style="width: 60px;
        padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyMiddleNoticeRowHeightBtn" class="height-apply-btn" data-target="middle-notice" style="margin-left: 5px;
        padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px;
        cursor: pointer;">ì ìš©</button>
        </div>

        <div>
            <label for="bottomRowHeightInput" style="display: block;
        margin-bottom: 5px;">í•˜ë‹¨ ë°ì´í„° í–‰ ë†’ì´:</label>
            <input type="number" id="bottomRowHeightInput" min="10" max="200" value="25" style="width: 60px;
        padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyBottomRowHeightBtn" class="height-apply-btn" data-target="bottom-data" style="margin-left: 5px;
        padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px;
        cursor: pointer;">ì ìš©</button>
        </div>
        <button id="autoFitBtn" class="small-btn" style="margin-top: 10px;
        width: 100%; background: #007bff;">ì—´ ë„ˆë¹„ ìë™ ë§ì¶¤ (Auto-Fit)</button>
    </div>

    <div style="margin-top: 15px; padding-top: 15px;
        border-top: 1px solid #444;">
        <h3>âš™ï¸ ì‘ì—… ë„êµ¬</h3>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
            <button id="autoSaveToggleBtn" class="small-btn">ìë™ì €ì¥: OFF</button>
            <button id="saveNowBtn" class="small-btn">ì €ì¥</button>
            <button id="copyBtn" class="small-btn">ë³µì‚¬</button>
            <button id="pasteBtn" class="small-btn">ë¶™ì—¬ë„£ê¸°</button>
        </div>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
            <button id="addRowBtn" class="small-btn">í–‰ ì¶”ê°€</button>
            <button id="addColBtn" class="small-btn">ì—´ ì¶”ê°€</button>
            <button id="deleteRowBtn" class="small-btn">í–‰ ì‚­ì œ</button>
            <button id="deleteColBtn" class="small-btn">ì—´ ì‚­ì œ</button>
        </div>
        <div style="display:flex; gap:8px;">
            <button id="toggleAdminBtn" class="small-btn" style="background: #a33;">ê´€ë¦¬ì ëª¨ë“œ: OFF</button>
            <button id="downloadBtn" class="small-btn" style="background: #4CAF50;">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <button class="download-button" id="downloadFullBtn" style="margin-top:12px;">ğŸ–¼ï¸ í…Œì´ë¸” ì˜ì—­ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (PNG)</button>
</div>

<div class="left-menu" id="leftMenu">
    <div class="left-item active">ë©”ì¸ í™”ë©´</div>
    <div class="left-item">[ë§¤ì¹­/ê³ ê° ìƒíƒœ]</div>
    <div class="left-item">ì£¼ë¬¸ ìƒíƒœ</div>
    <div class="left-item">ì¸ì¦ ìƒíƒœ</div>
    <div class="left-item">[ìƒë‹´/ë¬¸ì˜]</div>
    <div class="left-item">ì§ë¬´ ë¬¸ì˜</div>
    <div class="left-item">ì „êµ­ ë§Œë‚¨</div>
    <div class="left-item">[ê´€ë¦¬/ë°ì´í„°]</div>
    <div class="left-item">ì‹¤ì‹œê°„ ë°ì´í„°</div>
    <div class="left-item">ì‹¤ì‹œê°„ ì˜¤ë¥˜</div>
    <div class="left-item">ë°ì´í„° ë¶„ì„</div>
    <div class="left-item">í¬ì¸íŠ¸ ì¡°íšŒ</div>
    <div class="left-item">ìœ í¥ ê´€ë¦¬</div>
    <div class="left-item">íšŒì› ê´€ë¦¬</div>
    <div class="left-item">íšŒì› ìŠ¹ì¸</div>
    <div class="left-item">íšŒì› íƒˆí‡´</div>
    <div class="left-item">ë‹´ë‹¹ ì‹¤ì¥</div>
</div>

<div class="wrap">
    
    <img src="unnamed (8).png" alt="ë…¸ë¸”ë ˆìŠ¤ ë¡œê³ " class="header-logo">
    <div id="selectionBox"></div>

    <div class="top-sub-menu" id="topSubMenu">
        <div class="menu active">ë¸”ë ˆìŠ¤ ì „êµ­ í”„ë ˆìŠ¤í‹°ì§€ ì„œë¹„ìŠ¤</div>
        <div class="menu">VIP íšŒì› ì „ìš© í†µí•© ë§¤ë‹ˆì§€ë¨¼íŠ¸</div>
        <div class="menu">ë…¸ë¸”ë ˆìŠ¤ íšŒì› ì „ìš©ë£¸</div>
    </div>
    
    <div id="menuIndicator" class="menu-indicator">ì„ íƒ: ë©”ì¸ í™”ë©´</div>

    <table class="data-table" id="capture-area">
        <tbody>
            <tr class="top-notice-row">
                <td colspan="5" contenteditable="false">
                    <span class="top-notice-mark">DAMAGE!</span> ì£¼ì˜ì‚¬í•­ 4ë‹¨ê³„ì—ì„œ ì¼ì¹˜ íŒŒíŠ¸ë„ˆì‹­ìœ¼ë¡œ í†µí•©ëœ ìœ í˜•ë§Œì„ ì„ íƒí•˜ì—¬ ê³µìœ  ì„ë¬´ë¥¼ ì™„ë£Œí•˜ë©° í•¨ê»˜ í• ë•Œì˜ ê¸ˆì¼ ê²°ì œ ê¸ˆì•¡ í›„ ê³µë™ ì´ìµì„ ë§ˆê°í•´ì•¼ í•©ë‹ˆë‹¤!
                </td>
            </tr>
            
            <tr class="top-data-header">
                <td contenteditable="true">êµ¬ë¶„</td>
                <td contenteditable="true">íŒŒíŠ¸ë„ˆì‹­ ì™„ë£Œ</td>
                <td contenteditable="true">ê¸ˆì¼ ê²°ì œ (ì›)</td>
                <td contenteditable="true">ì´ ê²°ì œ ê¸ˆì•¡ (ì›)</td>
                <td contenteditable="true">ë§ˆê°ì¼</td>
            </tr>
            <tr class="top-data-row">
                <td contenteditable="true">í”„ë ˆìŠ¤í‹°ì§€ V1</td>
                <td contenteditable="true">1,000ê±´</td>
                <td contenteditable="true">3,000,000</td>
                <td contenteditable="true">30,000,000</td>
                <td contenteditable="true">2025-12-31</td>
            </tr>
            <tr class="top-data-row">
                <td contenteditable="true">í†µí•© ë§¤ë‹ˆì§€ë¨¼íŠ¸</td>
                <td contenteditable="true">500ê±´</td>
                <td contenteditable="true">5,000,000</td>
                <td contenteditable="true">50,000,000</td>
                <td contenteditable="true">2025-12-31</td>
            </tr>
            
            <tr class="middle-notice-row">
                <td colspan="5" contenteditable="true">
                    íŒŒíŠ¸ë„ˆì‹­ í†µí•© ë¶„ì„ ê²°ê³¼: V1ê³¼ ë§¤ë‹ˆì§€ë¨¼íŠ¸ ìœ í˜•ì˜ ì‹œë„ˆì§€ê°€ 20% ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.
                </td>
            </tr>

            <tr class="bottom-data-header">
                <td contenteditable="true">ë§¤ì¹­ êµ¬ë¶„</td>
                <td contenteditable="true">ì‹ ê·œ ë“±ë¡</td>
                <td contenteditable="true">ì§„í–‰ ì¤‘</td>
                <td contenteditable="true">ì„±ì‚¬ ì™„ë£Œ</td>
                <td contenteditable="true">ë¯¸ ì„±ì‚¬</td>
            </tr>
            <tr class="bottom-data-row">
                <td contenteditable="true">ì§ë¬´ ë§Œì¡± ë§¤ì¹­</td>
                <td contenteditable="true">150</td>
                <td contenteditable="true">80</td>
                <td contenteditable="true">50</td>
                <td contenteditable="true">20</td>
            </tr>
            <tr class="bottom-data-row">
                <td contenteditable="true">ì „êµ­ ë§Œë‚¨ ë§¤ì¹­</td>
                <td contenteditable="true">200</td>
                <td contenteditable="true">120</td>
                <td contenteditable="true">60</td>
                <td contenteditable="true">20</td>
            </tr>
            <tr class="bottom-data-row">
                <td contenteditable="true">VIP ì „ìš© ë§¤ì¹­</td>
                <td contenteditable="true">50</td>
                <td contenteditable="true">30</td>
                <td contenteditable="true">15</td>
                <td contenteditable="true">5</td>
            </tr>

        </tbody>
    </table>
</div>

<div class="resizer-display" id="resizerDisplay"></div>

<script type="module">
    // DOM Elements
    const table = document.getElementById('capture-area');
    const tbody = table.querySelector('tbody');
    const selectionBox = document.getElementById('selectionBox');
    const wrap = document.querySelector('.wrap');
    const settingPanel = document.getElementById('settingPanel');
    const leftMenu = document.getElementById('leftMenu');
    const topSubMenu = document.getElementById('topSubMenu');
    const menuIndicator = document.getElementById('menuIndicator');
    const resizerDisplay = document.getElementById('resizerDisplay');

    // State Variables
    let startCell = null;
    let isDragging = false;
    let isResizing = false;
    let resizeType = null; // 'col' or 'row'
    let resizeElement = null;
    let initialX, initialY, initialWidth, initialHeight;
    let selectedCells = [];
    let clipboard = [];
    let autoSaveTimer = null;
    let autoSaveActive = false;
    const LOCAL_STORAGE_KEY = 'noblesse_table_data_v2';

    // Color Palette
    const COLORS = [
        '#FFD700', '#FFA500', '#FF4500', '#DC143C', '#800000', 
        '#006400', '#228B22', '#3CB371', '#4682B4', '#1E90FF',
        '#4B0082', '#800080', '#DA70D6', '#FF69B4', '#FFC0CB',
        '#FFFFFF', '#DDDDDD', '#AAAAAA', '#777777', '#333333',
        '#000000', '#00FFFF', '#00BFFF', '#7B68EE', '#ADFF2F',
        '#FFFAFA', '#F0E68C', '#D2B48C', '#A0522D', '#DDA0DD',
        '#5F9EA0', '#8A2BE2', '#20B2AA', '#F08080', '#FAFAD2',
        '#808000', '#FF00FF', '#7CFC00', '#FF8C00', '#F0FFF0'
    ];

    /* ---------------------------------- */
    /* Table Functions           */
    /* ---------------------------------- */

    function getCells() { return Array.from(table.querySelectorAll('td')); }

    function clearSelection() {
        selectedCells.forEach(cell => cell.classList.remove('selected'));
        selectedCells = [];
        selectionBox.style.display = 'none';
    }

    function updateSelection(start, end) {
        clearSelection();
        if (!start || !end) return;

        const allCells = getCells();
        const startRect = start.getBoundingClientRect();
        const endRect = end.getBoundingClientRect();

        // Calculate Selection Box Coordinates (Relative to wrap)
        const wrapRect = wrap.getBoundingClientRect();
        const wrapScrollLeft = wrap.scrollLeft;
        const wrapScrollTop = wrap.scrollTop;

        let left = Math.min(startRect.left, endRect.left) + wrapScrollLeft - wrapRect.left;
        let top = Math.min(startRect.top, endRect.top) + wrapScrollTop - wrapRect.top;
        let width = Math.abs(startRect.left - endRect.left) + start.offsetWidth;
        let height = Math.abs(startRect.top - endRect.top) + start.offsetHeight;

        selectionBox.style.left = `${left}px`;
        selectionBox.style.top = `${top}px`;
        selectionBox.style.width = `${width}px`;
        selectionBox.style.height = `${height}px`;
        selectionBox.style.display = 'block';

        const startRowIndex = start.parentNode.rowIndex;
        const startColIndex = start.cellIndex;
        const endRowIndex = end.parentNode.rowIndex;
        const endColIndex = end.cellIndex;

        const minRow = Math.min(startRowIndex, endRowIndex);
        const maxRow = Math.max(startRowIndex, endRowIndex);
        const minCol = Math.min(startColIndex, endColIndex);
        const maxCol = Math.max(startColIndex, endColIndex);

        table.querySelectorAll('tr').forEach((row, rIdx) => {
            if (rIdx >= minRow && rIdx <= maxRow) {
                row.querySelectorAll('td').forEach((cell, cIdx) => {
                    if (cIdx >= minCol && cIdx <= maxCol) {
                        cell.classList.add('selected');
                        selectedCells.push(cell);
                    }
                });
            }
        });
    }

    function applyStyle(property, value) {
        selectedCells.forEach(cell => {
            if (cell.getAttribute('contenteditable') === 'true') {
                cell.style[property] = value;
            }
        });
        saveTableData();
    }

    /* ---------------------------------- */
    /* Data Persistence          */
    /* ---------------------------------- */

    function saveTableData() {
        const data = [];
        const colWidths = Array.from(table.querySelectorAll('tr')[1].querySelectorAll('td')).map(td => td.style.width || null);

        table.querySelectorAll('tr').forEach(row => {
            const rowData = {
                className: row.className,
                cells: Array.from(row.querySelectorAll('td')).map(cell => ({
                    content: cell.innerHTML,
                    style: cell.style.cssText,
                    colspan: cell.colSpan,
                    rowspan: cell.rowSpan,
                    editable: cell.getAttribute('contenteditable')
                }))
            };
            data.push(rowData);
        });

        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ data, colWidths }));
        console.log('Table data saved.');
        if(document.getElementById('saveNowBtn')) {
            document.getElementById('saveNowBtn').textContent = 'ì €ì¥ ì™„ë£Œ!';
            setTimeout(() => { document.getElementById('saveNowBtn').textContent = 'ì €ì¥'; }, 1000);
        }
    }

    function loadTableData() {
        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!savedData) return;

        try {
            const { data, colWidths } = JSON.parse(savedData);
            tbody.innerHTML = ''; // Clear current table body

            data.forEach(rowData => {
                const newRow = tbody.insertRow();
                newRow.className = rowData.className;

                rowData.cells.forEach(cellData => {
                    const newCell = newRow.insertCell();
                    newCell.innerHTML = cellData.content;
                    newCell.style.cssText = cellData.style;
                    if (cellData.colspan) newCell.colSpan = cellData.colspan;
                    if (cellData.rowspan) newCell.rowSpan = cellData.rowspan;
                    newCell.setAttribute('contenteditable', cellData.editable);
                });
            });

            // Restore column widths
            if (colWidths && colWidths.length > 0) {
                table.querySelectorAll('tr').forEach((row, rIdx) => {
                    const cells = Array.from(row.cells);
                    let colIndex = 0;
                    cells.forEach(cell => {
                        // Colspan ì²˜ë¦¬: ë³‘í•©ëœ ì…€ì€ ì—¬ëŸ¬ ì—´ ë„ˆë¹„ë¥¼ ì°¨ì§€
                        for(let i=0; i < cell.colSpan; i++) {
                            if (colIndex < colWidths.length && colWidths[colIndex]) {
                                cell.style.width = colWidths[colIndex];
                            }
                            colIndex++;
                        }
                    });
                });
            }

            // After loading, re-attach event listeners
            attachResizerListeners();
            console.log('Table data loaded.');
        } catch (e) {
            console.error("Error loading table data:", e);
            localStorage.removeItem(LOCAL_STORAGE_KEY); // Corrupt data, clear it
        }
    }

    function setupAutoSave() {
        const toggleBtn = document.getElementById('autoSaveToggleBtn');
        
        // Load initial state from local storage or set default
        const savedState = localStorage.getItem('autoSaveActive');
        autoSaveActive = savedState === 'true';

        if (autoSaveActive) {
            autoSaveTimer = setInterval(saveTableData, 5000); // 5 seconds
            toggleBtn.textContent = 'ìë™ì €ì¥: ON';
            toggleBtn.classList.add('active');
        } else {
            toggleBtn.textContent = 'ìë™ì €ì¥: OFF';
            toggleBtn.classList.remove('active');
        }

        toggleBtn.addEventListener('click', () => {
            autoSaveActive = !autoSaveActive;
            localStorage.setItem('autoSaveActive', autoSaveActive);
            if (autoSaveActive) {
                autoSaveTimer = setInterval(saveTableData, 5000);
                toggleBtn.textContent = 'ìë™ì €ì¥: ON';
                toggleBtn.classList.add('active');
            } else {
                clearInterval(autoSaveTimer);
                autoSaveTimer = null;
                toggleBtn.textContent = 'ìë™ì €ì¥: OFF';
                toggleBtn.classList.remove('active');
            }
        });
    }

    /* ---------------------------------- */
    /* Resizer Management          */
    /* ---------------------------------- */

    function createResizer(cell, type) {
        const resizer = document.createElement('div');
        resizer.className = type === 'col' ? 'col-resizer' : 'row-resizer';
        resizer.setAttribute('data-type', type);
        resizer.setAttribute('data-index', type === 'col' ? cell.cellIndex : cell.parentNode.rowIndex);

        // Prevent resizer on merged cells that aren't the primary one
        if (cell.colSpan > 1 && type === 'col') return;
        if (cell.rowSpan > 1 && type === 'row') return;
        
        cell.appendChild(resizer);
    }

    function attachResizerListeners() {
        // Clear existing resizers
        table.querySelectorAll('.col-resizer, .row-resizer').forEach(r => r.remove());

        const rows = table.querySelectorAll('tr');
        if (rows.length === 0) return;

        // Column resizers (only on header/data rows for consistency)
        rows[1].querySelectorAll('td').forEach(cell => {
            // Only add resizer to the last cell of a colspan group
            if (cell.colSpan === 1 && cell.cellIndex < table.rows[1].cells.length - 1) {
                 createResizer(cell, 'col');
            }
        });

        // Row resizers
        rows.forEach((row, index) => {
            // Add resizer to the last cell of the row (if not a colspan row)
            if (row.cells.length > 0) {
                const lastCell = row.cells[row.cells.length - 1];
                createResizer(lastCell, 'row');
            }
        });
    }

    function startResize(e, type) {
        e.preventDefault();
        e.stopPropagation();
        isResizing = true;
        resizeType = type;
        resizeElement = e.target.closest('td');

        initialX = e.clientX;
        initialY = e.clientY;

        if (resizeType === 'col') {
            initialWidth = resizeElement.offsetWidth;
            document.body.style.cursor = 'col-resize';
            resizerDisplay.style.opacity = '1';
        } else { // row
            initialHeight = resizeElement.parentNode.offsetHeight;
            document.body.style.cursor = 'row-resize';
            resizerDisplay.style.opacity = '1';
        }
    }

    function resizeMove(e) {
        if (!isResizing || !resizeElement) return;

        if (resizeType === 'col') {
            const dx = e.clientX - initialX;
            let newWidth = initialWidth + dx;
            if (newWidth < 30) newWidth = 30; // Min width

            // Get the actual column index (accounting for colspans)
            const colIndex = resizeElement.cellIndex;
            const targetCells = table.querySelectorAll('tr').flatMap(row => Array.from(row.cells).filter(cell => cell.cellIndex === colIndex));

            // Set width on the column cells (tds)
            targetCells.forEach(cell => {
                cell.style.width = `${newWidth}px`;
            });
            
            resizerDisplay.textContent = `W: ${Math.round(newWidth)}px`;
            resizerDisplay.style.left = `${e.clientX + 10}px`;
            resizerDisplay.style.top = `${e.clientY + 10}px`;

        } else if (resizeType === 'row') {
            const dy = e.clientY - initialY;
            let newHeight = initialHeight + dy;
            if (newHeight < 20) newHeight = 20; // Min height

            const row = resizeElement.parentNode;
            row.style.height = `${newHeight}px`;

            // Set line-height to center content vertically
            Array.from(row.cells).forEach(cell => {
                cell.style.lineHeight = `${newHeight - 10}px`; // Subtract vertical padding (5px * 2)
            });

            resizerDisplay.textContent = `H: ${Math.round(newHeight)}px`;
            resizerDisplay.style.left = `${e.clientX + 10}px`;
            resizerDisplay.style.top = `${e.clientY + 10}px`;
        }
    }

    function endResize() {
        if (!isResizing) return;
        isResizing = false;
        resizeType = null;
        resizeElement = null;
        document.body.style.cursor = 'default';
        resizerDisplay.style.opacity = '0';
        saveTableData(); // Save dimensions after resizing
    }

    function autoFitColumns() {
        table.style.tableLayout = 'auto';
        getCells().forEach(cell => {
            cell.style.width = ''; // Clear explicit widths
        });

        // Forced reflow to apply 'auto'
        const temp = table.offsetHeight; 

        // After reflow, set widths explicitly to maintain them
        const rows = table.querySelectorAll('tr');
        if (rows.length > 0) {
            Array.from(rows[1].cells).forEach(cell => {
                cell.style.width = `${cell.offsetWidth}px`;
            });
        }
        table.style.tableLayout = 'fixed'; // Restore fixed layout
        saveTableData();
    }


    /* ---------------------------------- */
    /* Event Handlers           */
    /* ---------------------------------- */

    document.addEventListener('mousedown', (e) => {
        if (e.target.closest('.col-resizer')) {
            startResize(e, 'col');
            return;
        }
        if (e.target.closest('.row-resizer')) {
            startResize(e, 'row');
            return;
        }

        const cell = e.target.closest('td');
        if (!cell || !wrap.contains(cell)) return;

        startCell = cell;
        isDragging = true;
        
        // Prevent default browser drag on elements that shouldn't be selected
        if(e.target.closest('.col-resizer, .row-resizer')) return;

        // Prevent browser selection for text fields when dragging starts
        if(document.activeElement && document.activeElement.isContentEditable) {
            document.activeElement.blur();
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (isResizing) {
            resizeMove(e);
            return;
        }
        if (!isDragging || !startCell) return;

        const currentCell = e.target.closest('td');
        if (currentCell) {
            updateSelection(startCell, currentCell);
        }
    });

    document.addEventListener('mouseup', (e) => {
        if (isResizing) {
            endResize();
            return;
        }
        if (isDragging) {
            isDragging = false;
            // Finalize selection after drag stops
            const endCell = e.target.closest('td');
            if (startCell && endCell) {
                updateSelection(startCell, endCell);
            }
            startCell = null;
        }
    });

    // Handle click outside table/controls to clear selection
    document.addEventListener('click', (e) => {
        const target = e.target;
        // ë“œë˜ê·¸ ì¤‘ì´ ì•„ë‹ˆê³ , í…Œì´ë¸”/ì„¤ì • íŒ¨ë„/ë©”ë‰´ë¥¼ í´ë¦­í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì„ íƒ í•´ì œ
        if (!isDragging && 
            !target.closest('.data-table') &&
            !target.closest('.setting-panel') &&
            !target.closest('.left-menu')) 
        {
            clearSelection();
        }
    });

    // Left menu & Top menu click behavior
    if (leftMenu) {
        leftMenu.addEventListener('click', (e) => {
            const li = e.target.closest('.left-item');
            if (!li) return;
            leftMenu.querySelectorAll('.left-item').forEach(it => it.classList.remove('active'));
            li.classList.add('active');
            if (menuIndicator) menuIndicator.textContent = `ì„ íƒ: ${li.textContent.trim()}`;
        });
    }
    if (topSubMenu) {
        topSubMenu.addEventListener('click', (e) => {
            const it = e.target.closest('.menu');
            if (!it) return;
            topSubMenu.querySelectorAll('.menu').forEach(m=>m.classList.remove('active'));
            it.classList.add('active');
        });
    }

    // Setting Panel Controls
    const colorPaletteContainer = document.getElementById('colorPaletteContainer');
    const colorTargetRadios = document.querySelectorAll('input[name="colorTarget"]');
    const fontSizeInput = document.getElementById('fontSizeInput');
    const applyFontSizeBtn = document.getElementById('applyFontSizeBtn');
    const heightApplyBtns = document.querySelectorAll('.height-apply-btn');
    const autoFitBtn = document.getElementById('autoFitBtn');
    const downloadFullBtn = document.getElementById('downloadFullBtn');
    const saveNowBtn = document.getElementById('saveNowBtn');
    
    // Copy/Paste Logic
    document.getElementById('copyBtn').addEventListener('click', () => {
        if (selectedCells.length === 0) return;
        clipboard = selectedCells.map(cell => cell.innerHTML);
        alert(`ì…€ ${clipboard.length}ê°œ ë³µì‚¬ ì™„ë£Œ.`);
    });

    document.getElementById('pasteBtn').addEventListener('click', () => {
        if (clipboard.length === 0 || selectedCells.length === 0) return;
        
        let pasteIndex = 0;
        selectedCells.forEach(cell => {
            if (cell.getAttribute('contenteditable') === 'true' && pasteIndex < clipboard.length) {
                cell.innerHTML = clipboard[pasteIndex];
                pasteIndex++;
            }
        });
        saveTableData();
    });

    // Row/Col manipulation
    document.getElementById('addRowBtn').addEventListener('click', () => {
        if (selectedCells.length === 0) {
            alert('í–‰ì„ ì¶”ê°€í•  ìœ„ì¹˜ì˜ ì…€ì„ í•˜ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        const refRow = selectedCells[0].parentNode;
        const newRow = refRow.cloneNode(true);
        newRow.className = 'bottom-data-row';
        Array.from(newRow.cells).forEach(cell => {
            cell.innerHTML = 'ìƒˆ ë°ì´í„°';
            cell.style.cssText = ''; // Clear custom styles
            cell.setAttribute('contenteditable', 'true');
        });
        refRow.parentNode.insertBefore(newRow, refRow.nextSibling);
        attachResizerListeners();
        saveTableData();
    });

    document.getElementById('addColBtn').addEventListener('click', () => {
        if (selectedCells.length === 0) {
            alert('ì—´ì„ ì¶”ê°€í•  ìœ„ì¹˜ì˜ ì…€ì„ í•˜ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        const refCellIndex = selectedCells[0].cellIndex;
        table.querySelectorAll('tr').forEach(row => {
            const refCell = row.cells[refCellIndex];
            if (!refCell) return;
            
            const newCell = row.insertCell(refCellIndex + 1);
            newCell.innerHTML = 'ìƒˆ ì—´';
            newCell.style.cssText = '';
            newCell.setAttribute('contenteditable', 'true');

            // Apply style based on row type
            if (row.classList.contains('top-data-header') || row.classList.contains('bottom-data-header')) {
                newCell.className = 'top-data-header'; 
                newCell.innerHTML = 'ìƒˆ ì œëª©';
            } else if (row.classList.contains('top-notice-row') || row.classList.contains('middle-notice-row')) {
                // If the reference cell had colspan, increase it
                if (refCell.colSpan > 1) {
                    refCell.colSpan += 1;
                    newCell.remove(); // Remove the newly inserted cell since it's merged
                } else {
                    newCell.innerHTML = 'ìƒˆ ê³µì§€';
                }
            } else {
                 newCell.className = 'bottom-data-row';
            }
        });
        attachResizerListeners();
        saveTableData();
    });

    document.getElementById('deleteRowBtn').addEventListener('click', () => {
        if (selectedCells.length === 0) {
            alert('ì‚­ì œí•  í–‰ì˜ ì…€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        if (!confirm(`${selectedCells.length}ê°œì˜ í–‰ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        
        const rowsToDelete = new Set(selectedCells.map(cell => cell.parentNode));
        rowsToDelete.forEach(row => row.remove());
        
        clearSelection();
        attachResizerListeners();
        saveTableData();
    });

    document.getElementById('deleteColBtn').addEventListener('click', () => {
        if (selectedCells.length === 0) {
            alert('ì‚­ì œí•  ì—´ì˜ ì…€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        if (!confirm('ì„ íƒëœ ì—´ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        const colIndexToDelete = selectedCells[0].cellIndex;
        table.querySelectorAll('tr').forEach(row => {
            // Check for colspan rows
            const cell = row.cells[colIndexToDelete];
            if (cell && cell.colSpan > 1) {
                cell.colSpan -= 1;
            } else if (cell) {
                row.deleteCell(colIndexToDelete);
            }
        });

        clearSelection();
        attachResizerListeners();
        saveTableData();
    });


    // Color Palette Render
    COLORS.forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = color;
        swatch.title = color;
        swatch.addEventListener('click', () => {
            const target = document.querySelector('input[name="colorTarget"]:checked').value;
            if (target === 'text') {
                applyStyle('color', color);
            } else {
                applyStyle('backgroundColor', color);
            }
        });
        colorPaletteContainer.appendChild(swatch);
    });

    // Font Size
    applyFontSizeBtn.addEventListener('click', () => {
        const size = fontSizeInput.value + 'px';
        applyStyle('fontSize', size);
    });

    // Row Height
    heightApplyBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const targetClass = e.target.getAttribute('data-target');
            const inputId = `${targetClass.replace('-', '')}RowHeightInput`;
            const height = document.getElementById(inputId).value + 'px';
            
            table.querySelectorAll(`tr.${targetClass}-row`).forEach(row => {
                row.style.height = height;
                const lineHeight = `${parseInt(height) - 10}px`;
                Array.from(row.cells).forEach(cell => {
                    cell.style.lineHeight = lineHeight;
                });
            });
            saveTableData();
        });
    });

    // Auto Fit
    autoFitBtn.addEventListener('click', autoFitColumns);

    // Download PNG
    downloadFullBtn.addEventListener('click', () => {
        const element = document.getElementById('capture-area');
        
        // Hide elements that shouldn't be in the image
        const tempResizers = table.querySelectorAll('.col-resizer, .row-resizer');
        tempResizers.forEach(r => r.style.display = 'none');
        clearSelection(); // Clear selection box

        html2canvas(element, { 
            backgroundColor: '#1a1a1a', // Set background color for a cleaner image
            scale: 2 // Use higher scale for better resolution
        }).then(canvas => {
            // Restore hidden elements
            tempResizers.forEach(r => r.style.display = 'block');

            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'noblesse_data_capture.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }).catch(err => {
             // Restore hidden elements even on error
            tempResizers.forEach(r => r.style.display = 'block');
            console.error("Image generation failed:", err);
            alert("ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)");
        });
    });

    // Admin Mode Toggle (Editable vs View Mode)
    document.getElementById('toggleAdminBtn').addEventListener('click', (e) => {
        const isCurrentlyAdmin = e.target.classList.contains('active');
        
        table.querySelectorAll('td').forEach(cell => {
            // Only toggle cells that were initially editable
            if (cell.getAttribute('data-initial-editable') === 'true') {
                cell.setAttribute('contenteditable', isCurrentlyAdmin ? 'false' : 'true');
            }
        });

        // Toggle button visual state
        if (isCurrentlyAdmin) {
            e.target.classList.remove('active');
            e.target.textContent = 'ê´€ë¦¬ì ëª¨ë“œ: OFF';
        } else {
            e.target.classList.add('active');
            e.target.textContent = 'ê´€ë¦¬ì ëª¨ë“œ: ON';
        }
        
        // Toggle Resizers visibility
        table.querySelectorAll('.col-resizer, .row-resizer').forEach(r => {
            r.style.display = isCurrentlyAdmin ? 'none' : 'block';
        });
    });

    // Initial setup
    function initialize() {
        // Save initial editable state
        table.querySelectorAll('td').forEach(cell => {
            cell.setAttribute('data-initial-editable', cell.getAttribute('contenteditable'));
        });

        // Initial load
        loadTableData(); 

        // Initial resizer setup
        attachResizerListeners();
        
        // Auto-save setup
        setupAutoSave();

        // Initial Admin Mode: OFF
        document.getElementById('toggleAdminBtn').click(); // Disable contenteditable initially
    }
    
    // Run initialization after DOM is fully loaded
    window.addEventListener('load', initialize);
</script>
</body>
</html>
